commit ed1d0e0ba6ea09b09fc43a2c347a7ad18c11ddad
Author: Nicolas Trangez <ikke@nicolast.be>
Date:   Fri Jan 6 02:03:09 2023 +0100

    Stash

diff --git a/.github/workflows/haskell-ci.yml b/.github/workflows/haskell-ci.yml
index 4ac3fbf..eb49c85 100644
--- a/.github/workflows/haskell-ci.yml
+++ b/.github/workflows/haskell-ci.yml
@@ -207,6 +207,7 @@ jobs:
       - name: build
         run: |
           $CABAL v2-build $ARG_COMPILER $ARG_TESTS $ARG_BENCH all --write-ghc-environment-files=always
+          mkdir -p /tmp/plans && cp dist-newstyle/cache/plan.json /tmp/plans/plan-$HCNUMVER.json
       - name: tests
         run: |
           $CABAL v2-test $ARG_COMPILER $ARG_TESTS $ARG_BENCH all --test-show-details=direct
@@ -229,6 +230,7 @@ jobs:
         run: |
           rm -f cabal.project.local
           $CABAL v2-build $ARG_COMPILER --disable-tests --disable-benchmarks all
+          mkdir -p /tmp/plans && cp dist-newstyle/cache/plan.json /tmp/plans/plan-$HCNUMVER-unconstrained.json
       - name: prepare for constraint sets
         run: |
           rm -f cabal.project.local
@@ -236,20 +238,24 @@ jobs:
         run: |
           if [ $((HCNUMVER >= 90400)) -ne 0 ] ; then $CABAL v2-build $ARG_COMPILER --disable-tests --disable-benchmarks --constraint='optparse-applicative ^>=0.17' --dependencies-only -j2 all ; fi
           if [ $((HCNUMVER >= 90400)) -ne 0 ] ; then $CABAL v2-build $ARG_COMPILER --disable-tests --disable-benchmarks --constraint='optparse-applicative ^>=0.17' all ; fi
+          if [ $((HCNUMVER >= 90400)) -ne 0 ] ; then mkdir -p /tmp/plans && cp dist-newstyle/cache/plan.json /tmp/plans/plan-$HCNUMVER-optparse-applicative-0.17.json; fi
       - name: constraint set optparse-applicative-0.16
         run: |
           if [ $((HCNUMVER >= 90400)) -ne 0 ] ; then $CABAL v2-build $ARG_COMPILER --disable-tests --disable-benchmarks --constraint='optparse-applicative ^>=0.16.1.0' --dependencies-only -j2 all ; fi
           if [ $((HCNUMVER >= 90400)) -ne 0 ] ; then $CABAL v2-build $ARG_COMPILER --disable-tests --disable-benchmarks --constraint='optparse-applicative ^>=0.16.1.0' all ; fi
+          if [ $((HCNUMVER >= 90400)) -ne 0 ] ; then mkdir -p /tmp/plans && cp dist-newstyle/cache/plan.json /tmp/plans/plan-$HCNUMVER-optparse-applicative-0.16.json; fi
       - name: constraint set unix-2.8
         run: |
           $CABAL v2-build $ARG_COMPILER --enable-tests --disable-benchmarks --constraint='unix ^>=2.8' --dependencies-only -j2 all
           $CABAL v2-build $ARG_COMPILER --enable-tests --disable-benchmarks --constraint='unix ^>=2.8' all
           $CABAL v2-test $ARG_COMPILER --enable-tests --disable-benchmarks --constraint='unix ^>=2.8' all
+          mkdir -p /tmp/plans && cp dist-newstyle/cache/plan.json /tmp/plans/plan-$HCNUMVER-unix-2.8.json
       - name: constraint set unix-2.7
         run: |
           $CABAL v2-build $ARG_COMPILER --enable-tests --disable-benchmarks --constraint='unix ^>=2.7' --dependencies-only -j2 all
           $CABAL v2-build $ARG_COMPILER --enable-tests --disable-benchmarks --constraint='unix ^>=2.7' all
           $CABAL v2-test $ARG_COMPILER --enable-tests --disable-benchmarks --constraint='unix ^>=2.7' all
+          mkdir -p /tmp/plans && cp dist-newstyle/cache/plan.json /tmp/plans/plan-$HCNUMVER-unix-2.7.json
       - name: constraint set lower-bounds-psx
         run: |
           if [ $((HCNUMVER < 90000)) -ne 0 ] ; then $CABAL v2-build $ARG_COMPILER --enable-tests --disable-benchmarks --constraint='async ==2.2.3
@@ -261,8 +267,12 @@ jobs:
           if [ $((HCNUMVER < 90000)) -ne 0 ] ; then $CABAL v2-test $ARG_COMPILER --enable-tests --disable-benchmarks --constraint='async ==2.2.3
           ' --constraint='tasty ==1.4.1
           ' --constraint='tasty-hunit ==0.10.0.3' all ; fi
+          if [ $((HCNUMVER < 90000)) -ne 0 ] ; then mkdir -p /tmp/plans && cp dist-newstyle/cache/plan.json /tmp/plans/plan-$HCNUMVER-lower-bounds-psx.json ; fi
       - name: constraint set lower-bounds-landlock
         run: |
+          mv cabal.project cabal.project.old
+          echo "packages: $GITHUB_WORKSPACE/source/landlock" >> cabal.project
+          echo "allow-older: psx-0.1.0.0:base" >> cabal.project
           if [ $((HCNUMVER < 90000)) -ne 0 ] ; then $CABAL v2-build $ARG_COMPILER --enable-tests --disable-benchmarks --constraint='async ==2.2.3
           ' --constraint='directory ==1.3.6.0
           ' --constraint='exceptions ==0.10.4
@@ -305,3 +315,48 @@ jobs:
           ' --constraint='tasty-quickcheck ==0.10.1.2
           ' --constraint='temporary ==1.3
           ' --constraint='unix ==2.7.2.2' all ; fi
+          if [ $((HCNUMVER < 90000)) -ne 0 ] ; then mkdir -p /tmp/plans && cp dist-newstyle/cache/plan.json /tmp/plans/plan-$HCNUMVER-lower-bounds-landlock.json ; fi
+          mv cabal.project.old cabal.project
+
+      - name: Upload build plan as artifact
+        uses: actions/upload-artifact@v3
+        with:
+          name: plans
+          path: /tmp/plans/plan-*.json
+
+  bounds:
+    runs-on: ubuntu-latest
+    name: Calculate cabal bounds
+    needs:
+    - linux
+    steps:
+    - name: Cache Cabal files
+      uses: actions/cache@v3
+      with:
+        path: |
+          ~/.cabal/packages
+          ~/.cabal/store
+        key: ${{ runner.os }}-cabal
+
+    - name: Install cabal-fmt
+      run: |
+        cabal update
+        cabal install "cabal-fmt-0.1.6"
+
+    - uses: actions/checkout@v3
+    - name: Fetch cabal-plan-bounds
+      run: |
+        curl -L https://github.com/nomeata/cabal-plan-bounds/releases/latest/download/cabal-plan-bounds.linux.gz | gunzip  > /usr/local/bin/cabal-plan-bounds
+        chmod +x /usr/local/bin/cabal-plan-bounds
+    - name: Load plans
+      uses: actions/download-artifact@v3
+      with:
+        name: plans
+        path: plans
+
+    - run: cabal-plan-bounds plans/*.json -c landlock/landlock.cabal -c psx/psx.cabal
+    - run: ~/.cabal/bin/cabal-fmt --inplace landlock/landlock.cabal psx/psx.cabal
+
+    - run: git diff landlock/landlock.cabal psx/psx.cabal
+
+    - run: git diff-files --quiet landlock/landlock.cabal psx/psx.cabal || exit 1
